<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h1>
            <div class="header-actions">
                <span class="user-info">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ session.username }}!</span>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary">–í—ã–π—Ç–∏</a>
            </div>
        </header>

        <main class="admin-content">
            {% if success %}
                <div class="alert alert-success">
                    {{ success }}
                </div>
            {% endif %}

            {% if error %}
                <div class="alert alert-error">
                    {{ error }}
                </div>
            {% endif %}

            <div class="actions-bar">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</h2>
                <button class="btn btn-primary" onclick="showAddForm()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                <button class="btn btn-secondary" onclick="toggleTagsManagement()">üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</button>
            </div>

            <!-- Tags Management Section -->
            <div id="tags-management" class="tags-management" style="display: none;">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</h3>

                <!-- Add Tag Form -->
                <form method="POST" action="{{ url_for('admin_dashboard') }}" class="tag-add-form">
                    <input type="hidden" name="action" value="add_tag">
                    <input type="text" name="tag_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞" required>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
                </form>

                <!-- Tags List -->
                <div class="tags-list">
                    {% for tag in tags %}
                    <div class="tag-item">
                        <span class="tag-name">{{ tag.name }}</span>
                        <form method="POST" action="{{ url_for('admin_dashboard') }}" style="display: inline;"
                              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ \'{{ tag.name }}\'? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –µ–≥–æ —Å–≤—è–∑–∏ —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏.')">
                            <input type="hidden" name="action" value="delete_tag">
                            <input type="hidden" name="tag_id" value="{{ tag.id }}">
                            <button type="submit" class="btn-delete-tag">√ó</button>
                        </form>
                    </div>
                    {% endfor %}

                    {% if not tags %}
                    <p class="empty-tags">–¢–µ–≥–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–µ–≥.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Add/Edit Project Form -->
            <div id="project-form" class="project-form" style="display: none;">
                <h3 id="form-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
                <form id="project-form-element" method="POST" action="{{ url_for('admin_dashboard') }}" enctype="multipart/form-data">
                    <input type="hidden" id="project-id" name="project_id">
                    <input type="hidden" name="action" value="save">

                    <div class="form-group">
                        <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:</label>
                        <input type="text" id="title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="description">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="description" name="description" rows="2" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="full_description">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="full_description" name="full_description" rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="live_url">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç:</label>
                        <input type="url" id="live_url" name="live_url" required>
                    </div>

                    <div class="form-group">
                        <label for="preview_image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:</label>
                        <input type="file" id="preview_image" name="preview_image" accept="image/*">
                        <small>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</small>
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–≥–∏ –ø—Ä–æ–µ–∫—Ç–∞:</label>
                        <div id="tags-checkboxes" class="tags-checkboxes">
                            {% for tag in tags %}
                            <label class="tag-checkbox">
                                <input type="checkbox" name="tags" value="{{ tag.id }}" id="tag-{{ tag.id }}">
                                <span>{{ tag.name }}</span>
                            </label>
                            {% endfor %}

                            {% if not tags %}
                            <p class="no-tags-message">–¢–µ–≥–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã. <a href="#" onclick="toggleTagsManagement(); return false;">–°–æ–∑–¥–∞—Ç—å —Ç–µ–≥–∏</a></p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>

            <!-- Projects List -->
            <div class="projects-list">
                {% for project in projects %}
                <div class="project-item">
                    <div class="project-preview">
                        <img src="{{ project.preview_image }}" alt="{{ project.title }}" onerror="this.src='/static/images/placeholder.jpg'">
                    </div>
                    <div class="project-info">
                        <h3>{{ project.title }}</h3>
                        <p class="project-description">{{ project.description }}</p>
                        <p class="project-url">
                            <a href="{{ project.live_url }}" target="_blank">{{ project.live_url }}</a>
                        </p>
                        {% if project.tags %}
                        <div class="project-tags-display">
                            {% for tag in project.tags %}
                            <span class="tag-badge">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <p class="project-meta">
                            –°–æ–∑–¥–∞–Ω: {{ project.created_at[:16] }}
                            {% if project.updated_at != project.created_at %}
                            | –û–±–Ω–æ–≤–ª–µ–Ω: {{ project.updated_at[:16] }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="project-actions">
                        <button class="btn btn-edit" onclick="editProject({{ project.id }})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-duplicate" onclick="duplicateProject({{ project.id }})">üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                        <form method="POST" action="{{ url_for('admin_dashboard') }}" style="display: inline;"
                              onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç?')">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="project_id" value="{{ project.id }}">
                            <button type="submit" class="btn btn-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                </div>
                {% endfor %}

                {% if not projects %}
                <div class="empty-state">
                    <h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <script>
        // Toggle tags management section
        function toggleTagsManagement() {
            const tagsSection = document.getElementById('tags-management');
            tagsSection.style.display = tagsSection.style.display === 'none' ? 'block' : 'none';
        }

        // Update tag checkboxes based on project tags
        function updateTagCheckboxes(projectTags) {
            // Clear all checkboxes first
            const checkboxes = document.querySelectorAll('input[name="tags"]');
            checkboxes.forEach(cb => cb.checked = false);

            // Check the ones that match project tags
            if (projectTags && projectTags.length > 0) {
                projectTags.forEach(tag => {
                    const checkbox = document.getElementById('tag-' + tag.id);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Project form management
        function showAddForm() {
            document.getElementById('form-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç';
            document.getElementById('project-form').style.display = 'block';
            document.getElementById('project-form-element').reset();
            document.getElementById('project-id').value = '';
            updateTagCheckboxes([]);
            window.scrollTo(0, document.getElementById('project-form').offsetTop);
        }

        function hideForm() {
            document.getElementById('project-form').style.display = 'none';
        }

        function editProject(projectId) {
            // Find project data
            const projects = {{ projects | tojson }};
            const project = projects.find(p => p.id === projectId);

            if (project) {
                document.getElementById('form-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç';
                document.getElementById('project-id').value = project.id;
                document.getElementById('title').value = project.title;
                document.getElementById('description').value = project.description;
                document.getElementById('full_description').value = project.full_description;
                document.getElementById('live_url').value = project.live_url;

                updateTagCheckboxes(project.tags || []);

                document.getElementById('project-form').style.display = 'block';
                window.scrollTo(0, document.getElementById('project-form').offsetTop);
            }
        }

        function duplicateProject(projectId) {
            // Find project data
            const projects = {{ projects | tojson }};
            const project = projects.find(p => p.id === projectId);

            if (project) {
                document.getElementById('form-title').textContent = '–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç';
                document.getElementById('project-id').value = ''; // Clear ID for new project
                document.getElementById('title').value = project.title + ' (–∫–æ–ø–∏—è)';
                document.getElementById('description').value = project.description;
                document.getElementById('full_description').value = project.full_description;
                document.getElementById('live_url').value = project.live_url;

                updateTagCheckboxes(project.tags || []);

                document.getElementById('project-form').style.display = 'block';
                window.scrollTo(0, document.getElementById('project-form').offsetTop);
            }
        }

        // Auto-hide alerts after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);
    </script>
</body>
</html>